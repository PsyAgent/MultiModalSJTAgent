{% extends "base.html" %}

{% block title %}å›¾ç‰‡é¢˜ç›®ç”Ÿæˆ - SJT Agent{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ğŸ–¼ï¸ å›¾ç‰‡é¢˜ç›®ç”Ÿæˆ</h2>
    <p>å°†æƒ…å¢ƒè½¬åŒ–ä¸ºå¯è§†åŒ–å›¾ç‰‡ï¼Œç”ŸæˆåŒ…å«åœºæ™¯ã€äººç‰©å’Œå¯¹è¯çš„å›¾ç‰‡æµ‹è¯•é¢˜ç›®</p>
    <p class="info-note">æ³¨æ„ï¼šæ­¤é¡µé¢ä»…æ˜¾ç¤ºåœ¨ PSJT-Mussel æ•°æ®é›†ä¸­æœ‰å¯ç”¨æƒ…å¢ƒçš„ç‰¹è´¨</p>
</div>

<div class="generation-container">
    <div class="form-section">
        <h3>é€‰æ‹©ç‰¹è´¨å’Œé¢˜ç›®</h3>

        <div class="form-group">
            <label for="trait-select">é€‰æ‹©äººæ ¼ç‰¹è´¨:</label>
            <select id="trait-select" class="form-control">
                <option value="">-- è¯·é€‰æ‹©ç‰¹è´¨ --</option>
                {% for key, trait in traits.items() %}
                <option value="{{ key }}" data-domain="{{ trait.domain }}">
                    {{ key }}: {{ trait.facet_name }} ({{ trait.domain }})
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>ç‰¹è´¨æè¿°:</label>
            <div id="trait-description" class="info-box">
                è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç‰¹è´¨
            </div>
        </div>

        <div class="form-group">
            <label for="situation-select">é€‰æ‹©æƒ…å¢ƒé¢˜ç›®:</label>
            <select id="situation-select" class="form-control" disabled>
                <option value="">-- å…ˆé€‰æ‹©ç‰¹è´¨ --</option>
            </select>
            <small class="form-text">ä»PSJT-Musselæ•°æ®é›†ä¸­é€‰æ‹©å·²æœ‰çš„æƒ…å¢ƒ</small>
        </div>

        <div class="form-group">
            <label>æƒ…å¢ƒå†…å®¹:</label>
            <div id="situation-content" class="info-box">
                è¯·å…ˆé€‰æ‹©æƒ…å¢ƒé¢˜ç›®
            </div>
        </div>

        <h3>ç”Ÿæˆå‚æ•°</h3>

        <div class="form-group">
            <label for="ref-character">å‚è€ƒè§’è‰²:</label>
            <select id="ref-character" class="form-control">
                <option value="male">ç”·æ€§</option>
                <option value="female">å¥³æ€§</option>
            </select>
        </div>

        <div class="form-group">
            <label for="run-bubble">ç”Ÿæˆå¯¹è¯æ°”æ³¡:</label>
            <input type="checkbox" id="run-bubble" checked>
            <small class="form-text">æ˜¯å¦åœ¨å›¾ç‰‡ä¸­æ·»åŠ å¯¹è¯æ°”æ³¡</small>
        </div>

        <button id="generate-btn" class="btn btn-primary btn-large">
            ç”Ÿæˆå›¾ç‰‡é¢˜ç›®
        </button>

        <div class="warning-box">
            <strong>âš ï¸ æ³¨æ„:</strong> å›¾ç‰‡ç”Ÿæˆå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·ç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®šå¹¶è€å¿ƒç­‰å¾…ã€‚
        </div>
    </div>

    <div class="result-section">
        <h3>
            <span>ç”Ÿæˆç»“æœ</span>
            <button id="clear-result-btn" class="clear-result-btn" style="display: none;">æ¸…é™¤ç»“æœ</button>
        </h3>
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...</p>
            <p class="small-text">å›¾ç‰‡ç”Ÿæˆå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
        </div>
        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="result-content" class="result-box">
            ç‚¹å‡»ç”ŸæˆæŒ‰é’®å¼€å§‹ç”Ÿæˆå›¾ç‰‡é¢˜ç›®
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const traits = {{ traits|tojson }};

    document.addEventListener('DOMContentLoaded', function() {
        const traitSelect = document.getElementById('trait-select');
        const situationSelect = document.getElementById('situation-select');
        const traitDescription = document.getElementById('trait-description');
        const situationContent = document.getElementById('situation-content');
        const generateBtn = document.getElementById('generate-btn');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const resultContent = document.getElementById('result-content');
        const clearResultBtn = document.getElementById('clear-result-btn');

        let currentSituations = {};

        // Clear result button handler
        clearResultBtn.addEventListener('click', function() {
            resultContent.textContent = 'ç‚¹å‡»ç”ŸæˆæŒ‰é’®å¼€å§‹ç”Ÿæˆå›¾ç‰‡é¢˜ç›®';
            errorMessage.style.display = 'none';
            clearResultBtn.style.display = 'none';
        });

        // When trait is selected
        traitSelect.addEventListener('change', async function() {
            const traitId = this.value;

            if (!traitId) {
                traitDescription.textContent = 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç‰¹è´¨';
                situationSelect.disabled = true;
                situationSelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©ç‰¹è´¨ --</option>';
                situationContent.textContent = 'è¯·å…ˆé€‰æ‹©æƒ…å¢ƒé¢˜ç›®';
                generateBtn.disabled = true;
                return;
            }

            // Show trait description
            const trait = traits[traitId];
            traitDescription.innerHTML = `
                <p><strong>ç‰¹è´¨åç§°:</strong> ${trait.facet_name}</p>
                <p><strong>æ‰€å±ç»´åº¦:</strong> ${trait.domain}</p>
                <p><strong>æè¿°:</strong> ${trait.description}</p>
                <p><strong>é«˜åˆ†ç‰¹å¾:</strong> ${trait.high_score}</p>
                <p><strong>ä½åˆ†ç‰¹å¾:</strong> ${trait.low_score}</p>
            `;

            // Load situations
            try {
                const response = await fetch(`/api/situations/${traitId}`);
                const data = await response.json();

                if (data.available && data.situations) {
                    currentSituations = data.situations;
                    situationSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©æƒ…å¢ƒ --</option>';

                    for (const [sitId, sitData] of Object.entries(data.situations)) {
                        const option = document.createElement('option');
                        option.value = sitId;
                        const preview = sitData.situation ? sitData.situation.substring(0, 40) :
                                      sitData.stem ? sitData.stem.substring(0, 40) :
                                      sitData.scenario ? sitData.scenario.substring(0, 40) : 'æ— é¢„è§ˆ';
                        option.textContent = `æƒ…å¢ƒ ${sitId}: ${preview}...`;
                        situationSelect.appendChild(option);
                    }

                    situationSelect.disabled = false;
                    situationContent.innerHTML = '<p class="info-text">è¯·ä»ä¸Šæ–¹ä¸‹æ‹‰èœå•é€‰æ‹©ä¸€ä¸ªæƒ…å¢ƒé¢˜ç›®</p>';
                } else {
                    // This should not happen since we filter traits on the backend
                    situationSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                    situationContent.innerHTML = `<p class="error-message">æ— æ³•åŠ è½½æƒ…å¢ƒæ•°æ®</p>`;
                }
            } catch (error) {
                console.error('Error loading situations:', error);
                situationSelect.innerHTML = '<option value="">åŠ è½½æƒ…å¢ƒå¤±è´¥</option>';
                situationContent.innerHTML = `<p class="error-message">åŠ è½½æƒ…å¢ƒå¤±è´¥: ${error.message}</p>`;
            }
        });

        // When situation is selected
        situationSelect.addEventListener('change', function() {
            const sitId = this.value;

            if (!sitId) {
                situationContent.textContent = 'è¯·é€‰æ‹©æƒ…å¢ƒé¢˜ç›®';
                generateBtn.disabled = true;
                return;
            }

            const situation = currentSituations[sitId];
            let contentHTML = `<p><strong>æƒ…å¢ƒ ${sitId}</strong></p>`;

            // Display situation content
            if (situation.situation) {
                contentHTML += `<p><strong>æƒ…å¢ƒæè¿°:</strong></p><p class="situation-text">${situation.situation}</p>`;
            }
            if (situation.stem) {
                contentHTML += `<p><strong>é¢˜å¹²:</strong></p><p class="situation-text">${situation.stem}</p>`;
            }
            if (situation.scenario) {
                contentHTML += `<p><strong>åœºæ™¯:</strong></p><p class="situation-text">${situation.scenario}</p>`;
            }

            // Display options if available
            if (situation.options) {
                contentHTML += `<p><strong>é€‰é¡¹:</strong></p><ul>`;
                const options = Array.isArray(situation.options) ? situation.options : Object.values(situation.options);
                options.forEach((opt, idx) => {
                    const optText = typeof opt === 'object' ? (opt.text || opt.content || JSON.stringify(opt)) : opt;
                    contentHTML += `<li>${String.fromCharCode(65 + idx)}. ${optText}</li>`;
                });
                contentHTML += `</ul>`;
            }

            situationContent.innerHTML = contentHTML;
            generateBtn.disabled = false;
        });

        // Generate button click
        generateBtn.addEventListener('click', async function() {
            const traitId = traitSelect.value;
            const sitId = situationSelect.value;
            const refCharacter = document.getElementById('ref-character').value;
            const runBubble = document.getElementById('run-bubble').checked;

            if (!traitId) {
                alert('è¯·å…ˆé€‰æ‹©ç‰¹è´¨');
                return;
            }

            if (!sitId) {
                alert('è¯·é€‰æ‹©æƒ…å¢ƒé¢˜ç›®');
                return;
            }

            // Show loading
            loading.style.display = 'block';
            errorMessage.style.display = 'none';
            resultContent.textContent = 'ç”Ÿæˆä¸­...';
            generateBtn.disabled = true;

            try {
                const response = await fetch('/api/generate/image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        trait_id: traitId,
                        item_id: sitId,
                        ref_character: refCharacter,
                        run_bubble: runBubble
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Display result
                    let resultHTML = `
                        <div class="success-message">âœ“ ç”ŸæˆæˆåŠŸ!</div>
                        <p><strong>è¾“å‡ºæ–‡ä»¶å‰ç¼€:</strong> ${data.output_file}</p>
                        <p><strong>è¾“å‡ºç›®å½•:</strong> ./outputs/</p>
                    `;

                    // Display generated images
                    if (data.has_images && data.image_files && data.image_files.length > 0) {
                        resultHTML += `
                            <div class="media-gallery">
                                <h4>ç”Ÿæˆçš„å›¾ç‰‡:</h4>
                        `;

                        data.image_files.forEach((filename, index) => {
                            resultHTML += `
                                <div class="media-item">
                                    <p class="media-label">å›¾ç‰‡ ${index + 1}: ${filename}</p>
                                    <img src="/outputs/${filename}"
                                         alt="ç”Ÿæˆçš„å›¾ç‰‡ ${index + 1}"
                                         class="generated-image"
                                         onclick="window.open('/outputs/${filename}', '_blank')">
                                    <p class="media-hint">ç‚¹å‡»å›¾ç‰‡åœ¨æ–°çª—å£ä¸­æŸ¥çœ‹å¤§å›¾</p>
                                </div>
                            `;
                        });

                        resultHTML += `</div>`;
                    } else {
                        resultHTML += `
                            <div class="warning-box">
                                <p>âš ï¸ æœªæ‰¾åˆ°ç”Ÿæˆçš„å›¾ç‰‡æ–‡ä»¶</p>
                                <p>å›¾ç‰‡å¯èƒ½ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨åæŸ¥çœ‹ outputs ç›®å½•</p>
                            </div>
                        `;
                    }

                    resultHTML += `
                        <div class="result-info">
                            <p>è¯¦ç»†ä¿¡æ¯æ–‡ä»¶:</p>
                            <ul>
                                <li>${data.output_file}_details.json</li>
                            </ul>
                        </div>
                        <details>
                            <summary>æŸ¥çœ‹è¯¦ç»†JSONæ•°æ®</summary>
                            <pre>${JSON.stringify(data.result, null, 2)}</pre>
                        </details>
                    `;

                    resultContent.innerHTML = resultHTML;
                    clearResultBtn.style.display = 'inline-block';
                } else {
                    throw new Error(data.error || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = `ç”Ÿæˆå¤±è´¥: ${error.message}`;
                errorMessage.style.display = 'block';
                resultContent.textContent = 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·æŸ¥çœ‹é”™è¯¯ä¿¡æ¯';
                clearResultBtn.style.display = 'inline-block';
            } finally {
                loading.style.display = 'none';
                generateBtn.disabled = false;
            }
        });
    });
</script>
{% endblock %}
