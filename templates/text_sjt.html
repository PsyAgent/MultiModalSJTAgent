{% extends "base.html" %}

{% block title %}æ–‡å­—é¢˜ç›®ç”Ÿæˆ - SJT Agent{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ğŸ“ æ–‡å­—é¢˜ç›®ç”Ÿæˆ</h2>
    <p>åŸºäºé€‰å®šçš„äººæ ¼ç‰¹è´¨å’Œå‚è€ƒé¢˜ç›®ç”Ÿæˆæ–‡å­—æƒ…å¢ƒåˆ¤æ–­æµ‹è¯•</p>
</div>

<div class="generation-container">
    <div class="form-section">
        <h3>é€‰æ‹©ç‰¹è´¨å’Œé¢˜ç›®</h3>

        <div class="form-group">
            <label for="trait-select">é€‰æ‹©äººæ ¼ç‰¹è´¨:</label>
            <select id="trait-select" class="form-control">
                <option value="">-- è¯·é€‰æ‹©ç‰¹è´¨ --</option>
                {% for key, trait in traits.items() %}
                <option value="{{ key }}" data-domain="{{ trait.domain }}">
                    {{ key }}: {{ trait.facet_name }} ({{ trait.domain }})
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>ç‰¹è´¨æè¿°:</label>
            <div id="trait-description" class="info-box">
                è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç‰¹è´¨
            </div>
        </div>

        <div class="form-group">
            <label for="item-select">é€‰æ‹©å‚è€ƒé¢˜ç›®:</label>
            <select id="item-select" class="form-control" disabled>
                <option value="">-- å…ˆé€‰æ‹©ç‰¹è´¨ --</option>
            </select>
        </div>

        <div class="form-group">
            <label>é¢˜ç›®å†…å®¹:</label>
            <div id="item-content" class="info-box">
                è¯·å…ˆé€‰æ‹©é¢˜ç›®
            </div>
        </div>

        <h3>ç”Ÿæˆå‚æ•°</h3>

        <div class="form-group">
            <label for="situation-theme">æƒ…å¢ƒä¸»é¢˜:</label>
            <input type="text" id="situation-theme" class="form-control" value="å¤§å­¦ç”Ÿæ´»" placeholder="ä¾‹å¦‚: å¤§å­¦ç”Ÿæ´»ã€èŒåœºç¯å¢ƒ">
        </div>

        <div class="form-group">
            <label for="target-population">ç›®æ ‡äººç¾¤:</label>
            <input type="text" id="target-population" class="form-control" value="ä¸­å›½å¤§å­¦ç”Ÿ" placeholder="ä¾‹å¦‚: ä¸­å›½å¤§å­¦ç”Ÿã€ä¼ä¸šå‘˜å·¥">
        </div>

        <div class="form-group">
            <label for="n-items">ç”Ÿæˆé¢˜ç›®æ•°é‡:</label>
            <input type="number" id="n-items" class="form-control" value="1" min="1" max="5">
        </div>

        <button id="generate-btn" class="btn btn-primary btn-large" disabled>
            ç”Ÿæˆæ–‡å­—é¢˜ç›®
        </button>
    </div>

    <div class="result-section">
        <h3>
            <span>ç”Ÿæˆç»“æœ</span>
            <button id="clear-result-btn" class="clear-result-btn" style="display: none;">æ¸…é™¤ç»“æœ</button>
        </h3>
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...</p>
        </div>
        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="result-content" class="result-box">
            ç‚¹å‡»ç”ŸæˆæŒ‰é’®å¼€å§‹ç”Ÿæˆé¢˜ç›®
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const traits = {{ traits|tojson }};

    document.addEventListener('DOMContentLoaded', function() {
        const traitSelect = document.getElementById('trait-select');
        const itemSelect = document.getElementById('item-select');
        const traitDescription = document.getElementById('trait-description');
        const itemContent = document.getElementById('item-content');
        const generateBtn = document.getElementById('generate-btn');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const resultContent = document.getElementById('result-content');
        const clearResultBtn = document.getElementById('clear-result-btn');

        // Clear result button handler
        clearResultBtn.addEventListener('click', function() {
            resultContent.textContent = 'ç‚¹å‡»ç”ŸæˆæŒ‰é’®å¼€å§‹ç”Ÿæˆé¢˜ç›®';
            errorMessage.style.display = 'none';
            clearResultBtn.style.display = 'none';
        });

        // When trait is selected
        traitSelect.addEventListener('change', async function() {
            const traitId = this.value;

            if (!traitId) {
                traitDescription.textContent = 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç‰¹è´¨';
                itemSelect.disabled = true;
                itemSelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©ç‰¹è´¨ --</option>';
                generateBtn.disabled = true;
                return;
            }

            // Show trait description
            const trait = traits[traitId];
            traitDescription.innerHTML = `
                <p><strong>ç‰¹è´¨åç§°:</strong> ${trait.facet_name}</p>
                <p><strong>æ‰€å±ç»´åº¦:</strong> ${trait.domain}</p>
                <p><strong>æè¿°:</strong> ${trait.description}</p>
                <p><strong>é«˜åˆ†ç‰¹å¾:</strong> ${trait.high_score}</p>
                <p><strong>ä½åˆ†ç‰¹å¾:</strong> ${trait.low_score}</p>
            `;

            // Load items
            try {
                const response = await fetch(`/api/items/${traitId}`);
                const items = await response.json();

                itemSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©é¢˜ç›® --</option>';
                for (const [itemId, itemData] of Object.entries(items)) {
                    const option = document.createElement('option');
                    option.value = itemId;
                    option.textContent = `é¢˜ç›® ${itemId}: ${itemData.item.substring(0, 30)}...`;
                    itemSelect.appendChild(option);
                }

                itemSelect.disabled = false;
            } catch (error) {
                console.error('Error loading items:', error);
                itemSelect.innerHTML = '<option value="">åŠ è½½é¢˜ç›®å¤±è´¥</option>';
            }
        });

        // When item is selected
        itemSelect.addEventListener('change', async function() {
            const itemId = this.value;
            const traitId = traitSelect.value;

            if (!itemId) {
                itemContent.textContent = 'è¯·å…ˆé€‰æ‹©é¢˜ç›®';
                generateBtn.disabled = true;
                return;
            }

            try {
                const response = await fetch(`/api/items/${traitId}`);
                const items = await response.json();
                const item = items[itemId];

                itemContent.innerHTML = `
                    <p><strong>é¢˜ç›®å†…å®¹:</strong> ${item.item}</p>
                    <p><strong>è®¡åˆ†æ–¹å¼:</strong> ${item.scoring}</p>
                `;

                generateBtn.disabled = false;
            } catch (error) {
                console.error('Error loading item:', error);
                itemContent.textContent = 'åŠ è½½é¢˜ç›®å†…å®¹å¤±è´¥';
            }
        });

        // Generate button click
        generateBtn.addEventListener('click', async function() {
            const traitId = traitSelect.value;
            const itemId = itemSelect.value;
            const situationTheme = document.getElementById('situation-theme').value;
            const targetPopulation = document.getElementById('target-population').value;
            const nItems = parseInt(document.getElementById('n-items').value);

            if (!traitId || !itemId) {
                alert('è¯·å…ˆé€‰æ‹©ç‰¹è´¨å’Œé¢˜ç›®');
                return;
            }

            // Show loading
            loading.style.display = 'block';
            errorMessage.style.display = 'none';
            resultContent.textContent = 'ç”Ÿæˆä¸­...';
            generateBtn.disabled = true;

            try {
                const response = await fetch('/api/generate/text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        trait_id: traitId,
                        item_id: itemId,
                        situation_theme: situationTheme,
                        target_population: targetPopulation,
                        n_items: nItems
                    })
                });

                const data = await response.json();

                console.log('API Response:', data);

                if (data.success) {
                    // Check if result is an array
                    let resultItems = data.result;
                    if (!Array.isArray(resultItems)) {
                        console.log('Result is not an array, type:', typeof resultItems);
                        // Try to handle different data structures
                        if (typeof resultItems === 'object' && resultItems !== null) {
                            // If it's an object, try to extract items
                            if (resultItems.items && Array.isArray(resultItems.items)) {
                                resultItems = resultItems.items;
                            } else {
                                // Convert single object to array
                                resultItems = [resultItems];
                            }
                        } else {
                            resultItems = [];
                        }
                    }

                    // Display result
                    let resultHTML = `
                        <div class="success-message">âœ“ ç”ŸæˆæˆåŠŸ!</div>
                        <p><strong>è¾“å‡ºæ–‡ä»¶:</strong> ${data.output_file}</p>
                    `;

                    if (resultItems.length > 0) {
                        resultHTML += `<div class="result-items">
                            ${resultItems.map((item, index) => `
                                <div class="result-item">
                                    <h4>é¢˜ç›® ${index + 1}</h4>
                                    <p><strong>æƒ…å¢ƒ:</strong> ${item.situation || item.stem || item.scenario || 'æ— '}</p>
                                    ${item.options ? `
                                        <p><strong>é€‰é¡¹:</strong></p>
                                        <ul>
                                            ${(Array.isArray(item.options) ? item.options : Object.values(item.options)).map(opt => `<li>${typeof opt === 'object' ? opt.text || opt.content || JSON.stringify(opt) : opt}</li>`).join('')}
                                        </ul>
                                    ` : '<p><strong>é€‰é¡¹:</strong> æ— é€‰é¡¹</p>'}
                                </div>
                            `).join('')}
                        </div>`;
                    } else {
                        resultHTML += '<p class="warning-box">ç”Ÿæˆç»“æœä¸ºç©º</p>';
                    }

                    resultHTML += `<pre>${JSON.stringify(data.result, null, 2)}</pre>`;
                    resultContent.innerHTML = resultHTML;
                    clearResultBtn.style.display = 'inline-block';
                } else {
                    throw new Error(data.error || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = `ç”Ÿæˆå¤±è´¥: ${error.message}`;
                errorMessage.style.display = 'block';
                resultContent.textContent = 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·æŸ¥çœ‹é”™è¯¯ä¿¡æ¯';
                clearResultBtn.style.display = 'inline-block';
            } finally {
                loading.style.display = 'none';
                generateBtn.disabled = false;
            }
        });
    });
</script>
{% endblock %}
